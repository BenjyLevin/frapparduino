#!/usr/bin/env node
var debug = require('debug')('app');
var app = require('../app');

app.set('port', process.env.PORT || 3000);

var server = app.listen(app.get('port'), function() {
  debug('Express server listening on port ' + server.address().port);
});

var device = [];

var io = require('socket.io').listen(server);
io.on('connection', function (socket) {
  socket.on('order', function (data) {
    console.log(data);
    if (data['type'] ==  'mocha')
    {
    	mocha();
    } 
    else if (data['type'] ==  'caramel')
    {
    	caramel();
    }
    else if (data['type'] ==  'coffee')
    {
    	coffee();
    }
  });
});

// FRAPPARDUINO STUFF
var five = require("johnny-five"),
	board = new five.Board();

board.on("ready",function(){
	console.log("Board Ready");
    for (var i = 1; i <= 5; i++) {
    	try {
            console.log("Setting up relay pin " + (i+1));
            device[i] = new five.Relay(i+1);
            //if(!device[i].id) throw err;
            // not too sure how to throw error here if the device is not actually present
            // maybe this is not possible?! sighs
            console.log("success");
        }
        catch(err){
            console.log("SETTING UP RELAY PIN " + (i+1) + " FAILED!");
    }};

	  this.repl.inject({
	  	// milk
	  	bot1 : device[1],
	  	// coffee base
	  	bot2 : device[2],
	  	// cream base
	  	bot3 : device[3],
	  	// caramel sauce
	  	bot4 : device[4],
	  	// mocha sauce
	  	bot5 : device[5],
	  	// coffee
	  	bot6 : device[6],
        // turn blender on
        blender_on_button : device[7],
        // turn blender off
        blender_off_button : device[8]
        // servo
        // servo : device[9]

	  });
	  console.log("Components initialized");
});

console.log("\n Connecting to the arduino...");

var bot1 = device[1];
var bot2 = device[2];
var bot3 = device[3];
var bot4 = device[4];
var bot5 = device[5];
var bot6 = device[6];
var blender_on_button = device[7];
var blender_off_button = device[8];
//var servo = device[9];

function mocha(){
    try{
	// amount of milk
    bot1.on();
    setTimeout(function(){bot1.off()},2000);
    // amount of coffee base
    bot2.on();
    setTimeout(function(){bot2.off()},2000);
    // amount of mocha sauce
    bot4.on()
    setTime(function(){bot4.off()},2000);
    // amount of coffee
    bot6.on()
    setTime(function(){bot6.off()},2000);
    }
    catch(err){console.log("Sorry something went wrong with the Mocha dispensing function - please check that all appropriate bottles are installed.");}
}

function caramel(){
    try{
	// amount of milk
    bot1.on();
    setTimeout(function(){bot1.off()},2000);
    // amount of coffee base
    bot2.on();
    setTimeout(function(){bot2.off()},2000);
    // amount of mocha sauce
    bot5.on()
    setTime(function(){bot5.off()},2000);
    // amount of coffee
    bot6.on()
    setTime(function(){bot6.off()},2000);
    }
    catch(err){console.log("Sorry something went wrong with the Mocha dispensing function - please check that all appropriate bottles are installed.");}
}

function coffee(){
    try{
	// amount of milk
    bot1.on();
    setTimeout(function(){bot1.off()},2000);
    // amount of coffee base
    bot2.on();
    setTimeout(function(){bot2.off()},2000);
    // amount of coffee
    bot6.on()
    setTime(function(){bot6.off()},2000);
    }
    catch(err){console.log("Sorry something went wrong with the Mocha dispensing function - please check that all appropriate bottles are installed.");}
}